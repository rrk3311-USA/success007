<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Success Chemistry - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            height: 40px;
            width: auto;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .tabs {
            background: white;
            border-bottom: 2px solid #ddd;
            display: flex;
            padding: 0 30px;
            gap: 5px;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #2c3e50;
            background: #f8f8f8;
        }

        .tab.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            font-weight: 600;
        }

        .content {
            padding: 20px 30px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input, select, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        input {
            flex: 1;
            min-width: 200px;
        }

        select {
            background: white;
            cursor: pointer;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: #2980b9;
        }

        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-completed { background: #d4edda; color: #155724; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-pending { background: #fff3cd; color: #856404; }

        .action-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .action-btn:hover {
            background: #2980b9;
        }

        .product-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .product-grid.layout-1col {
            grid-template-columns: 1fr;
        }

        .product-grid.layout-2col {
            grid-template-columns: repeat(2, 1fr);
        }

        .product-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .heat-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .sales-badge {
            background: #2c3e50;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .medal-badge {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            border-radius: 2px;
            margin-right: 6px;
        }

        .medal-gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: #fff; }
        .medal-silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: #fff; }
        .medal-bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f5f5f5;
        }

        .product-info {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.4;
            color: #2c3e50;
            min-height: 40px;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #27ae60;
            margin: 4px 0;
        }

        .product-sku {
            font-size: 0.85rem;
            color: #666;
        }

        .product-description {
            font-size: 0.88rem;
            color: #555;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin: 4px 0;
        }

        .product-stock {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            font-weight: 600;
            white-space: nowrap;
        }

        .stock-in { background: #d4edda; color: #155724; }
        .stock-low { background: #fff3cd; color: #856404; }
        .stock-out { background: #f8d7da; color: #721c24; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 4px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            color: #333;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .detail-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            font-weight: 600;
            width: 150px;
            color: #666;
        }

        .detail-value {
            flex: 1;
        }
    

.footer {
            background: #2854a6;
            color: white;
            padding: 80px 0 30px;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 60px;
            margin-bottom: 60px;
        }

        .footer-brand p {
            margin-top: 20px;
            opacity: 0.8;
            line-height: 1.6;
        }

        .footer-logo img {
            height: 50px;
        }

        .footer-links h4 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.9);
        }

        .footer-links a {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .footer-links a:hover {
            color: white;
            text-decoration: underline;
        }

        .footer-bottom {
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-legal {
            display: flex;
            gap: 20px;
        }

        .footer-legal a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .footer-legal a:hover {
            color: white;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .product-header h1 {
                font-size: 2.2rem;
            }
            
            .price {
                font-size: 2rem;
            }
            
            .description-grid {
                grid-template-columns: 1fr;
            }
            
            .footer-grid {
                grid-template-columns: 1fr;
                gap: 40px;
            }
            
            .footer-bottom {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
        }

</style>
</head>
<body>
    <div class="header">
        <img src="/public/images/SC_logo_withR.png" alt="Success Chemistry Logo" class="header-logo">
        <h1>Success Chemistry Dashboard</h1>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">‚ö° Life Command</button>
        <button class="tab" onclick="switchTab('products')">üì¶ Products</button>
        <button class="tab" onclick="switchTab('crm')">üë• CRM & Orders</button>
        <button class="tab" onclick="switchTab('analytics')">üìà Analytics</button>
    </div>

    <div class="content">
        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="controls" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="action-btn" id="timeframe-today" onclick="setTimeframe('today')">Today</button>
                    <button class="action-btn" id="timeframe-week" onclick="setTimeframe('week')">This Week</button>
                    <button class="action-btn" id="timeframe-month" onclick="setTimeframe('month')" style="background: #27ae60;">This Month</button>
                    <button class="action-btn" id="timeframe-year" onclick="setTimeframe('year')">This Year</button>
                    <button class="action-btn" id="timeframe-all" onclick="setTimeframe('all')">All Time</button>
                </div>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">$0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCustomers">0</div>
                    <div class="stat-label">Total Customers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Products</div>
                </div>
            </div>

            <!-- Task List & Milestones -->
            <div style="margin-top: 40px;">
                <h2 style="margin-bottom: 20px; font-size: 1.5rem; color: #2c3e50;">‚úÖ Task List & Milestones</h2>
                
                <!-- Milestone Selector -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="action-btn" id="milestone-1" onclick="setMilestone(1)" style="background: #27ae60; flex: 1;">üìç Milestone 1</button>
                    <button class="action-btn" id="milestone-2" onclick="setMilestone(2)" style="flex: 1;">üìç Milestone 2</button>
                    <button class="action-btn" id="milestone-3" onclick="setMilestone(3)" style="flex: 1;">üìç Milestone 3</button>
                </div>

                <!-- Task Input -->
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="taskInput" placeholder="Add new task..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                        <button class="action-btn" onclick="addTask()" style="padding: 10px 20px;">‚ûï Add</button>
                        <button class="action-btn" onclick="togglePromptBuilder()" style="padding: 10px 20px; background: #9c27b0;">‚ú® Prompt Builder</button>
                    </div>

                    <!-- Prompt Builder -->
                    <div id="promptBuilder" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: #9c27b0;">‚ú® AI Prompt Builder</h4>
                        <div style="display: grid; gap: 10px;">
                            <button class="action-btn" onclick="suggestPrompt('analyze')" style="background: #667eea; font-size: 0.85rem; padding: 8px;">üìä Analyze customer data for insights</button>
                            <button class="action-btn" onclick="suggestPrompt('optimize')" style="background: #764ba2; font-size: 0.85rem; padding: 8px;">‚ö° Optimize conversion funnel</button>
                            <button class="action-btn" onclick="suggestPrompt('content')" style="background: #4caf50; font-size: 0.85rem; padding: 8px;">‚úçÔ∏è Generate product descriptions</button>
                            <button class="action-btn" onclick="suggestPrompt('campaign')" style="background: #ff9800; font-size: 0.85rem; padding: 8px;">üì¢ Create ad campaign strategy</button>
                            <button class="action-btn" onclick="suggestPrompt('retention')" style="background: #2196f3; font-size: 0.85rem; padding: 8px;">üéØ Build customer retention plan</button>
                        </div>
                    </div>

                    <!-- Task List -->
                    <div id="taskList" style="display: grid; gap: 10px;">
                        <div style="text-align: center; padding: 20px; color: #999;">No tasks yet. Add your first task above!</div>
                    </div>
                </div>
            </div>

            <!-- SEO Optimization for Top 12 Sellers -->
            <div style="margin-top: 40px;">
                <h2 style="margin-bottom: 20px; font-size: 1.5rem; color: #2c3e50;">üîç SEO Optimization - Top 12 Sellers</h2>
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="action-btn" onclick="loadTop12ForSEO()" style="background: #27ae60;">üìä Load Top 12 Products</button>
                        <button class="action-btn" onclick="generateSEOPrompts()" style="background: #9c27b0;">‚ú® Generate SEO Prompts</button>
                        <button class="action-btn" onclick="saveAllSEO()" style="background: #ff9800;">üíæ Save All Changes</button>
                    </div>
                    <div id="seoProductList" style="display: grid; gap: 15px;">
                        <div style="text-align: center; padding: 40px; color: #999;">Click "Load Top 12 Products" to start SEO optimization</div>
                    </div>
                </div>
            </div>

            <!-- Fleet Manager Vision Board -->
            <div style="margin-top: 40px;">
                <h2 style="margin-bottom: 20px; font-size: 1.5rem; color: #2c3e50;">ü§ñ Fleet Manager Agents</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; border: 1px solid #e0e0e0;">
                        <h3 style="margin-bottom: 10px; color: #667eea; font-size: 1.1rem;">üîÑ Subscription Optimizer</h3>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.5;">Analyzing customer behavior for subscription opportunities</p>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(118, 75, 162, 0.1) 0%, rgba(156, 39, 176, 0.1) 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #764ba2; border: 1px solid #e0e0e0;">
                        <h3 style="margin-bottom: 10px; color: #764ba2; font-size: 1.1rem;">üí∞ Upsell Agent</h3>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.5;">Creating intelligent product bundles and recommendations</p>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(67, 160, 71, 0.1) 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50; border: 1px solid #e0e0e0;">
                        <h3 style="margin-bottom: 10px; color: #4caf50; font-size: 1.1rem;">‚úçÔ∏è Content Agent</h3>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.5;">Generating SEO-optimized, compliant content</p>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(245, 124, 0, 0.1) 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800; border: 1px solid #e0e0e0;">
                        <h3 style="margin-bottom: 10px; color: #ff9800; font-size: 1.1rem;">üì¢ Ad Agent</h3>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.5;">Monitoring and optimizing ad campaigns</p>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(25, 118, 210, 0.1) 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3; border: 1px solid #e0e0e0;">
                        <h3 style="margin-bottom: 10px; color: #2196f3; font-size: 1.1rem;">üéØ Retention Agent</h3>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.5;">Predicting churn and triggering win-backs</p>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(123, 31, 162, 0.1) 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #9c27b0; border: 1px solid #e0e0e0;">
                        <h3 style="margin-bottom: 10px; color: #9c27b0; font-size: 1.1rem;">‚úÖ Trust Agent</h3>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.5;">Enforcing FDA/FTC compliance</p>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(0, 188, 212, 0.1) 0%, rgba(0, 172, 193, 0.1) 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #00bcd4; border: 1px solid #e0e0e0;">
                        <h3 style="margin-bottom: 10px; color: #00bcd4; font-size: 1.1rem;">üíµ Pricing Agent</h3>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.5;">Dynamic pricing and demand forecasting</p>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 179, 0, 0.1) 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107; border: 1px solid #e0e0e0;">
                        <h3 style="margin-bottom: 10px; color: #ffc107; font-size: 1.1rem;">üëÅÔ∏è Overseer Agent</h3>
                        <p style="color: #666; font-size: 0.9rem; line-height: 1.5;">Coordinating all agents and reporting</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="products" class="tab-content">
            <h2 style="margin-bottom: 20px;">Products</h2>
            
            <!-- View Filter Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="action-btn" id="view-all" onclick="setProductView('all')" style="background: #27ae60; font-size: 0.9rem; padding: 10px 20px; flex: 1;">üì¶ View All</button>
                <button class="action-btn" id="view-recent" onclick="setProductView('recent')" style="font-size: 0.9rem; padding: 10px 20px; flex: 1;">üÜï Recently Added</button>
                <button class="action-btn" id="view-top12" onclick="setProductView('top12')" style="font-size: 0.9rem; padding: 10px 20px; flex: 1;">üèÜ Top 12 Sellers</button>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <button class="action-btn" id="layout-2col" onclick="setProductLayout(2)" style="background: #27ae60; font-size: 0.9rem; padding: 10px 20px; flex: 1; max-width: 200px;">‚ñ¶ 2 Column</button>
                    <button class="action-btn" id="layout-1col" onclick="setProductLayout(1)" style="font-size: 0.9rem; padding: 10px 20px; flex: 1; max-width: 200px;">‚ñ• 1 Column</button>
                    <div style="display: flex; gap: 5px; margin-left: auto;">
                        <button class="action-btn" onclick="previousProductPage()" style="padding: 10px 15px; font-size: 1.2rem;">‚óÄ</button>
                        <span id="productPageInfo" style="padding: 10px 15px; background: #f5f5f5; border-radius: 4px; font-weight: 600; min-width: 80px; text-align: center;">1 / 1</span>
                        <button class="action-btn" onclick="nextProductPage()" style="padding: 10px 15px; font-size: 1.2rem;">‚ñ∂</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="search" id="productSearch" placeholder="Search products..." onkeyup="filterProducts()" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <select id="productCategory" onchange="filterProducts()" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All Categories</option>
                    </select>
                </div>
            </div>

            <div class="product-grid" id="productsGrid" style="grid-template-columns: repeat(2, 1fr);">
                <div style="text-align: center; padding: 40px;">Loading products...</div>
            </div>
        </div>

        <!-- CRM & ORDERS TAB -->
        <div id="crm" class="tab-content">
            <h2 style="margin-bottom: 20px;">Customers & Orders</h2>
            <div style="margin-bottom: 15px;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                    <button class="action-btn" id="sort-date-desc" onclick="setSortCRM('date-desc')" style="background: #27ae60; font-size: 0.85rem; padding: 8px 16px;">üìÖ Newest</button>
                    <button class="action-btn" id="sort-date-asc" onclick="setSortCRM('date-asc')" style="font-size: 0.85rem; padding: 8px 16px;">üìÖ Oldest</button>
                    <button class="action-btn" id="sort-spend-desc" onclick="setSortCRM('spend-desc')" style="font-size: 0.85rem; padding: 8px 16px;">üí∞ High Spend</button>
                    <button class="action-btn" id="sort-spend-asc" onclick="setSortCRM('spend-asc')" style="font-size: 0.85rem; padding: 8px 16px;">üí∞ Low Spend</button>
                    <button class="action-btn" id="sort-orders-desc" onclick="setSortCRM('orders-desc')" style="font-size: 0.85rem; padding: 8px 16px;">üì¶ Most Orders</button>
                    <button class="action-btn" id="sort-orders-asc" onclick="setSortCRM('orders-asc')" style="font-size: 0.85rem; padding: 8px 16px;">üì¶ Least Orders</button>
                    <button class="action-btn" onclick="refreshData()" style="font-size: 0.85rem; padding: 8px 16px;">üîÑ Refresh</button>
                </div>
                <input type="search" id="crmSearch" placeholder="Search customers or orders..." onkeyup="filterCRM()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Actions</th>
                        <th>Customer</th>
                        <th>Email</th>
                        <th style="cursor: pointer;" onclick="sortByColumn('spend')">Total Spent ‚ñº</th>
                        <th style="cursor: pointer;" onclick="sortByColumn('orders')">Orders ‚ñº</th>
                        <th style="cursor: pointer;" onclick="sortByColumn('date')">Last Order ‚ñº</th>
                        <th>Products Ordered</th>
                    </tr>
                </thead>
                <tbody id="crmTable">
                    <tr><td colspan="7" style="text-align: center; padding: 40px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalPageViews">0</div>
                    <div class="stat-label">Page Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueVisitors">0</div>
                    <div class="stat-label">Unique Visitors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="conversionRate">0%</div>
                    <div class="stat-label">Conversion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgSessionTime">0s</div>
                    <div class="stat-label">Avg Session Time</div>
                </div>
            </div>

            <!-- Traffic Sources -->
            <div style="margin-top: 40px;">
                <h2 style="margin-bottom: 20px; font-size: 1.5rem; color: #2c3e50;">üåê Traffic Sources</h2>
                <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
                    <div id="trafficSources" style="display: grid; gap: 15px;">
                        <div style="text-align: center; padding: 20px; color: #999;">Loading traffic sources...</div>
                    </div>
                </div>
            </div>

            <!-- Top Buyer Locations -->
            <div style="margin-top: 40px;">
                <h2 style="margin-bottom: 20px; font-size: 1.5rem; color: #2c3e50;">üìç Top Buyer Locations</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Top States -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: #2c3e50; font-size: 1.2rem;">üó∫Ô∏è Top States</h3>
                        <div id="topStates" style="display: grid; gap: 10px;">
                            <div style="text-align: center; padding: 20px; color: #999;">Loading...</div>
                        </div>
                    </div>
                    <!-- Top Cities -->
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: #2c3e50; font-size: 1.2rem;">üèôÔ∏è Top Cities</h3>
                        <div id="topCities" style="display: grid; gap: 10px;">
                            <div style="text-align: center; padding: 20px; color: #999;">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalCustomerTitle">Customer Details</h2>
                <button class="close-btn" onclick="closeCustomerModal()">&times;</button>
            </div>
            <div id="modalCustomerContent"></div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 id="modalProductTitle">Product Details</h2>
                <button class="close-btn" onclick="closeProductModal()">&times;</button>
            </div>
            <div id="modalProductContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        let customers = [];
        let wooCustomers = [];
        let orders = [];
        let products = [];
        let currentTab = 'overview';
        let currentTimeframe = 'month';
        let productLayout = 2; // 1 or 2 columns
        let currentProductPage = 1;
        let filteredProducts = [];
        let currentMilestone = 1;
        let currentProductView = 'all'; // 'all', 'recent', 'top12'
        let tasks = {
            1: [],
            2: [],
            3: []
        };

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
        }

        async function loadData() {
            try {
                // Load customers
                const customersRes = await fetch(`${API_BASE}/api/customers`);
                customers = await customersRes.json();

                // Load WooCommerce customers
                const wooRes = await fetch(`${API_BASE}/api/woocommerce/customers?per_page=100`);
                if (wooRes.ok) {
                    const wooData = await wooRes.json();
                    wooCustomers = wooData.customers || [];
                }

                // Load orders
                const ordersRes = await fetch(`${API_BASE}/api/orders`);
                orders = await ordersRes.json();

                // Load products
                const productsRes = await fetch(`${API_BASE}/api/products`);
                products = await productsRes.json();

                filteredProducts = products;
                displayCRM(customers);
                displayProducts(products);
                updateStats();
                populateCategories();
                loadAnalytics();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function setTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // Update button styles
            document.querySelectorAll('[id^="timeframe-"]').forEach(btn => {
                btn.style.background = '#3498db';
            });
            document.getElementById(`timeframe-${timeframe}`).style.background = '#27ae60';
            
            updateStats();
        }

        function filterOrdersByTimeframe(ordersList) {
            if (currentTimeframe === 'all') return ordersList;
            
            const now = new Date();
            const startDate = new Date();
            
            switch(currentTimeframe) {
                case 'today':
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'year':
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
            }
            
            return ordersList.filter(order => {
                const orderDate = new Date(order.date_created);
                return orderDate >= startDate;
            });
        }

        function updateStats() {
            const filteredOrders = filterOrdersByTimeframe(orders);
            
            // Only count completed orders (exclude failed, pending, abandoned carts, etc.)
            const completedOrders = filteredOrders.filter(o => o.status === 'completed');
            const totalRevenue = completedOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
            
            // Get unique customers from completed orders only
            const uniqueCustomers = new Set(completedOrders.map(o => o.customer_email).filter(e => e));
            
            document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalOrders').textContent = completedOrders.length;
            document.getElementById('totalCustomers').textContent = uniqueCustomers.size;
            document.getElementById('totalProducts').textContent = products.length;
        }

        function displayCRM(customerList) {
            const table = document.getElementById('crmTable');
            
            if (customerList.length === 0) {
                table.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No customers found</td></tr>';
                return;
            }

            table.innerHTML = customerList.map(customer => {
                const customerOrders = orders.filter(o => o.customer_email === customer.email);
                const totalSpent = customerOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
                const orderCount = customerOrders.length;
                const lastOrder = customerOrders.length > 0 
                    ? new Date(customerOrders[customerOrders.length - 1].date_created).toLocaleDateString()
                    : 'Never';

                // Extract all products and SKUs from orders
                const allProducts = [];
                const skuCounts = {};
                
                customerOrders.forEach(order => {
                    try {
                        const lineItems = typeof order.line_items === 'string' 
                            ? JSON.parse(order.line_items) 
                            : order.line_items;
                        
                        if (Array.isArray(lineItems)) {
                            lineItems.forEach(item => {
                                const sku = item.sku || 'N/A';
                                const productName = item.name || 'Unknown Product';
                                const qty = item.quantity || 1;
                                
                                if (!skuCounts[sku]) {
                                    skuCounts[sku] = { name: productName, count: 0 };
                                }
                                skuCounts[sku].count += qty;
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing line items:', e);
                    }
                });

                const productSummary = Object.entries(skuCounts)
                    .map(([sku, data]) => `${data.name} (${data.count})`)
                    .join(', ') || 'No products';

                return `
                    <tr>
                        <td>
                            <button class="action-btn" onclick="viewCustomer('${customer.email}')">View</button>
                        </td>
                        <td><strong>${customer.name || 'N/A'}</strong></td>
                        <td>${customer.email}</td>
                        <td><strong>$${totalSpent.toFixed(2)}</strong></td>
                        <td>${orderCount}</td>
                        <td>${lastOrder}</td>
                        <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${productSummary}">${productSummary}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayProducts(productList) {
            const grid = document.getElementById('productsGrid');
            
            if (productList.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px;">No products found</div>';
                return;
            }

            // Calculate sales volume for each product (COMPLETED ORDERS ONLY)
            const productsWithSales = productList.map(product => {
                let totalSales = 0;
                
                // Only count completed orders (exclude failed, pending, abandoned carts)
                const completedOrders = orders.filter(o => o.status === 'completed');
                
                completedOrders.forEach(order => {
                    try {
                        const lineItems = typeof order.line_items === 'string' 
                            ? JSON.parse(order.line_items) 
                            : order.line_items;
                        
                        if (Array.isArray(lineItems)) {
                            lineItems.forEach(item => {
                                if (item.sku === product.sku) {
                                    totalSales += parseInt(item.quantity || 0);
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing line items:', e);
                    }
                });
                return { ...product, salesVolume: totalSales };
            });

            // Sort by sales volume (highest first)
            let sortedProducts = productsWithSales.sort((a, b) => b.salesVolume - a.salesVolume);
            
            // Limit to top 12 if in top12 view
            if (currentProductView === 'top12') {
                sortedProducts = sortedProducts.slice(0, 12);
            }

            // Show all products at once for all views - no pagination
            const paginatedProducts = sortedProducts;
            const totalPages = 1;
            currentProductPage = 1;

            // Update page info
            document.getElementById('productPageInfo').textContent = `${currentProductPage} / ${totalPages}`;

            // Find max sales for heat map calculation
            const maxSales = Math.max(...sortedProducts.map(p => p.salesVolume), 1);

            grid.innerHTML = paginatedProducts.map((product, pageIndex) => {
                // Use pageIndex directly as we're showing all products
                const index = pageIndex;
                const stock = parseInt(product.stock || 0);
                let stockClass = 'stock-out';
                let stockText = 'Out of Stock';
                
                if (stock >= 100000) {
                    stockClass = 'stock-in';
                    stockText = `In Stock (${stock.toLocaleString()})`;
                } else if (stock > 0) {
                    stockClass = 'stock-low';
                    stockText = `Low Stock (${stock.toLocaleString()})`;
                }

                const description = product.short_description || product.description || '';
                const cleanDescription = description.replace(/<[^>]*>/g, '').substring(0, 120);

                const imageUrl = product.image_url || '/images/placeholder.jpg';

                // Calculate heat level (0-100 scale)
                const heatLevel = maxSales > 0 ? (product.salesVolume / maxSales) * 100 : 0;
                
                // Generate gradient from yellow to red based on heat level
                let heatColor = '';
                let heatEmoji = '';
                if (heatLevel >= 75) {
                    heatColor = `rgb(${220 + (heatLevel - 75)}, ${50 - (heatLevel - 75) * 2}, 30)`; // Red
                    heatEmoji = 'üî•';
                } else if (heatLevel >= 50) {
                    heatColor = `rgb(255, ${100 + (75 - heatLevel) * 2}, 30)`; // Orange
                    heatEmoji = 'üî•';
                } else if (heatLevel >= 25) {
                    heatColor = `rgb(255, ${180 + (50 - heatLevel) * 2}, 30)`; // Yellow-Orange
                    heatEmoji = '‚ö°';
                } else if (heatLevel > 0) {
                    heatColor = `rgb(255, 220, ${100 + heatLevel * 2})`; // Yellow
                    heatEmoji = 'üíõ';
                } else {
                    heatColor = '#ccc'; // Gray for no sales
                    heatEmoji = '‚Äî';
                }

                const leaderboardRank = index + 1;
                const fullImageUrl = `http://localhost:3001${product.image_url}`;

                // Determine medal for top 8
                let medalBadge = '';
                if (leaderboardRank === 1) {
                    medalBadge = '<span class="medal-badge medal-gold">ü•á</span>';
                } else if (leaderboardRank === 2) {
                    medalBadge = '<span class="medal-badge medal-silver">ü•à</span>';
                } else if (leaderboardRank === 3) {
                    medalBadge = '<span class="medal-badge medal-bronze">ü•â</span>';
                } else if (leaderboardRank >= 4 && leaderboardRank <= 8) {
                    medalBadge = '<span class="medal-badge medal-bronze">‚òÖ</span>';
                }

                return `
                    <div class="product-card">
                        <img src="${fullImageUrl}" alt="${product.name}" class="product-image" onclick="viewProduct('${product.sku}')" style="cursor: pointer;" onerror="this.style.display='none'">
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">$${parseFloat(product.price || 0).toFixed(2)}</div>
                            <div class="sales-badge">
                                ${medalBadge}
                                <span style="opacity: 0.7; font-size: 0.8rem;">#${leaderboardRank}</span>
                                <span style="margin: 0 5px;">‚Ä¢</span>
                                ${product.salesVolume} units sold
                            </div>
                            ${cleanDescription ? `<div class="product-description">${cleanDescription}...</div>` : ''}
                            <div style="font-size: 0.85rem; color: #666; line-height: 1.6;">
                                <div>SKU: ${product.sku}</div>
                                ${product.upc ? `<div>UPC: ${product.upc}</div>` : ''}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 10px;">
                                <span style="font-size: 0.85rem; color: #666; font-weight: 500;">üì¶ ${product.category || 'Uncategorized'}</span>
                                <span class="product-stock ${stockClass}">${stockText}</span>
                            </div>
                            <button class="action-btn" style="width: 100%; margin-top: 10px;" onclick="viewProduct('${product.sku}')">View Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateCategories() {
            const categories = [...new Set(products.map(p => p.category).filter(c => c))];
            const select = document.getElementById('productCategory');
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }

        let currentCRMSort = 'date-desc';

        function setSortCRM(sortType) {
            currentCRMSort = sortType;
            
            // Update button styles
            document.querySelectorAll('[id^="sort-"]').forEach(btn => {
                btn.style.background = '#3498db';
            });
            document.getElementById(`sort-${sortType}`).style.background = '#27ae60';
            
            filterCRM();
        }

        function filterCRM() {
            const search = document.getElementById('crmSearch').value.toLowerCase();
            let filtered = customers.filter(c => 
                (c.name || '').toLowerCase().includes(search) ||
                (c.email || '').toLowerCase().includes(search)
            );
            
            if (currentCRMSort) {
                filtered = applySortToCRM(filtered, currentCRMSort);
            }
            
            displayCRM(filtered);
        }

        let currentSortColumn = '';
        let currentSortDirection = 'desc';

        function sortCRM() {
            filterCRM();
        }

        function sortByColumn(column) {
            // Toggle direction if clicking same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'desc';
            }

            // Map column to sort value
            let sortValue = '';
            switch(column) {
                case 'spend':
                    sortValue = 'spend-' + currentSortDirection;
                    break;
                case 'orders':
                    sortValue = 'orders-' + currentSortDirection;
                    break;
                case 'date':
                    sortValue = 'date-' + currentSortDirection;
                    break;
            }

            // Update dropdown to match
            document.getElementById('crmSort').value = sortValue;
            
            // Apply sort
            filterCRM();
        }

        function applySortToCRM(customerList, sortValue) {
            const sorted = [...customerList];
            
            switch(sortValue) {
                case 'date-desc':
                    return sorted.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
                case 'date-asc':
                    return sorted.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
                case 'spend-desc':
                    return sorted.sort((a, b) => getCustomerTotalSpend(b) - getCustomerTotalSpend(a));
                case 'spend-asc':
                    return sorted.sort((a, b) => getCustomerTotalSpend(a) - getCustomerTotalSpend(b));
                case 'orders-desc':
                    return sorted.sort((a, b) => getCustomerOrderCount(b) - getCustomerOrderCount(a));
                case 'orders-asc':
                    return sorted.sort((a, b) => getCustomerOrderCount(a) - getCustomerOrderCount(b));
                default:
                    return sorted;
            }
        }

        function getCustomerTotalSpend(customer) {
            const customerOrders = orders.filter(o => o.customer_email === customer.email);
            return customerOrders.reduce((sum, order) => sum + parseFloat(order.total || 0), 0);
        }

        function getCustomerOrderCount(customer) {
            return orders.filter(o => o.customer_email === customer.email).length;
        }

        function setProductLayout(columns) {
            productLayout = columns;
            currentProductPage = 1;
            
            // Update button styles
            document.getElementById('layout-1col').style.background = columns === 1 ? '#27ae60' : '#3498db';
            document.getElementById('layout-2col').style.background = columns === 2 ? '#27ae60' : '#3498db';
            
            // Update grid class
            const grid = document.getElementById('productsGrid');
            grid.className = `product-grid layout-${columns}col`;
            
            displayProducts(filteredProducts);
        }

        function nextProductPage() {
            const itemsPerPage = productLayout;
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            
            if (currentProductPage < totalPages) {
                currentProductPage++;
                displayProducts(filteredProducts);
            }
        }

        function previousProductPage() {
            if (currentProductPage > 1) {
                currentProductPage--;
                displayProducts(filteredProducts);
            }
        }

        function setProductView(view) {
            console.log('setProductView called with:', view);
            currentProductView = view;
            currentProductPage = 1;
            
            // Update button styles
            document.getElementById('view-all').style.background = view === 'all' ? '#27ae60' : '#3498db';
            document.getElementById('view-recent').style.background = view === 'recent' ? '#27ae60' : '#3498db';
            document.getElementById('view-top12').style.background = view === 'top12' ? '#27ae60' : '#3498db';
            
            console.log('Current view set to:', currentProductView);
            filterProducts();
        }

        function filterProducts() {
            const search = document.getElementById('productSearch').value.toLowerCase();
            const category = document.getElementById('productCategory').value;
            
            console.log('filterProducts called, currentProductView:', currentProductView);
            console.log('Total products:', products.length);
            
            let filtered = products;
            
            // Apply view filter first
            if (currentProductView === 'recent') {
                // Sort by ID (assuming higher ID = more recent) and take last 20
                filtered = [...products].sort((a, b) => b.id - a.id).slice(0, 20);
                console.log('Recent view - filtered to:', filtered.length, 'products');
            } else if (currentProductView === 'top12') {
                // Will be sorted by sales volume in displayProducts, just mark to limit to 12
                filtered = products;
                console.log('Top 12 view - will be limited in displayProducts');
            }
            
            if (search) {
                filtered = filtered.filter(p => 
                    (p.name || '').toLowerCase().includes(search) ||
                    (p.sku || '').toLowerCase().includes(search)
                );
            }
            
            if (category) {
                filtered = filtered.filter(p => p.category === category);
            }
            
            filteredProducts = filtered;
            currentProductPage = 1;
            displayProducts(filtered);
        }

        function viewCustomer(email) {
            const customer = customers.find(c => c.email === email);
            const wooCustomer = wooCustomers.find(c => c.email === email);
            
            if (!customer) {
                alert('Customer not found');
                return;
            }

            const customerOrders = orders.filter(o => o.customer_email === email);
            const totalSpent = customerOrders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);

            const billing = wooCustomer?.billing || {};
            const shipping = wooCustomer?.shipping || {};

            const orderHistoryHTML = customerOrders.length > 0 ? customerOrders.map(order => {
                let lineItemsHTML = '';
                try {
                    const lineItems = typeof order.line_items === 'string' 
                        ? JSON.parse(order.line_items) 
                        : order.line_items;
                    
                    if (Array.isArray(lineItems) && lineItems.length > 0) {
                        lineItemsHTML = '<div style="margin-top: 10px; padding-left: 20px; font-size: 0.9rem;">' +
                            lineItems.map(item => `
                                <div style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">
                                    <strong>${item.name || 'Product'}</strong><br>
                                    SKU: ${item.sku || 'N/A'} | 
                                    Qty: ${item.quantity || 1} √ó $${parseFloat(item.price || 0).toFixed(2)} = 
                                    <strong>$${parseFloat(item.total || 0).toFixed(2)}</strong>
                                </div>
                            `).join('') +
                            '</div>';
                    }
                } catch (e) {
                    console.error('Error parsing line items:', e);
                }

                return `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <div class="detail-row" style="border: none;">
                            <span class="detail-label">Order #${order.woo_order_id || order.id}</span>
                            <span class="detail-value">
                                <strong>$${parseFloat(order.total || 0).toFixed(2)}</strong> - 
                                ${new Date(order.date_created).toLocaleDateString()} - 
                                <span class="status-badge status-${order.status}">${order.status}</span>
                            </span>
                        </div>
                        ${lineItemsHTML}
                    </div>
                `;
            }).join('') : '<p>No orders yet</p>';

            document.getElementById('modalCustomerTitle').textContent = customer.name || customer.email;
            document.getElementById('modalCustomerContent').innerHTML = `
                <div class="detail-section">
                    <h3>Customer Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value">${customer.email}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Spent:</span>
                        <span class="detail-value"><strong>$${totalSpent.toFixed(2)}</strong></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Orders:</span>
                        <span class="detail-value"><strong>${customerOrders.length}</strong></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span class="detail-value">${billing.phone || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Billing Address</h3>
                    <div class="detail-row">
                        <span class="detail-label">Address:</span>
                        <span class="detail-value">${billing.address_1 || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">City:</span>
                        <span class="detail-value">${billing.city || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">State/ZIP:</span>
                        <span class="detail-value">${billing.state || 'N/A'} ${billing.postcode || ''}</span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Order History (${customerOrders.length} orders)</h3>
                    ${orderHistoryHTML}
                </div>
            `;
            
            document.getElementById('customerModal').classList.add('active');
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.remove('active');
        }

        function viewProduct(sku) {
            const product = products.find(p => p.sku === sku);
            if (!product) {
                alert('Product not found');
                return;
            }

            // Get all images for this product
            const imageDir = `/images/products/${sku}/`;
            const heroImage = product.image_url ? `${API_BASE}${product.image_url}` : '';
            
            // Full description (strip HTML tags)
            const fullDescription = (product.description || '').replace(/<[^>]*>/g, '');
            const shortDesc = (product.short_description || '').replace(/<[^>]*>/g, '');

            // Calculate sales
            const completedOrders = orders.filter(o => o.status === 'completed');
            let totalSales = 0;
            completedOrders.forEach(order => {
                try {
                    const lineItems = typeof order.line_items === 'string' ? JSON.parse(order.line_items) : order.line_items;
                    if (Array.isArray(lineItems)) {
                        lineItems.forEach(item => {
                            if (item.sku === sku) totalSales += parseInt(item.quantity || 0);
                        });
                    }
                } catch (e) {}
            });

            document.getElementById('modalProductTitle').textContent = product.name;
            document.getElementById('modalProductContent').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <img src="${heroImage}" alt="${product.name}" style="width: 100%; border-radius: 8px; margin-bottom: 15px;" onerror="this.style.display='none'">
                        <div id="productGallery" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;"></div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; color: #27ae60; margin-bottom: 15px;">$${parseFloat(product.price || 0).toFixed(2)}</div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <span class="sales-badge">${totalSales} units sold</span>
                            <span class="product-stock stock-in">In Stock (${parseInt(product.stock || 0).toLocaleString()})</span>
                        </div>

                        <div class="detail-section">
                            <h3>Product Details</h3>
                            <div class="detail-row">
                                <span class="detail-label">SKU:</span>
                                <span class="detail-value">${product.sku}</span>
                            </div>
                            ${product.upc ? `<div class="detail-row"><span class="detail-label">UPC:</span><span class="detail-value">${product.upc}</span></div>` : ''}
                            <div class="detail-row">
                                <span class="detail-label">Category:</span>
                                <span class="detail-value">${product.category || 'Uncategorized'}</span>
                            </div>
                        </div>

                        ${shortDesc ? `<div class="detail-section"><h3>Short Description</h3><p style="line-height: 1.6;">${shortDesc}</p></div>` : ''}
                    </div>
                </div>

                ${fullDescription ? `
                <div class="detail-section" style="margin-top: 30px;">
                    <h3>Full Description</h3>
                    <div style="line-height: 1.8; white-space: pre-wrap;">${fullDescription}</div>
                </div>
                ` : ''}
                
                <div style="margin-top: 30px; text-align: center; padding-top: 20px; border-top: 1px solid #eee;">
                    <button class="action-btn" onclick="closeProductModal()" style="padding: 12px 40px; font-size: 1rem;">Close</button>
                </div>
            `;

            document.getElementById('productModal').classList.add('active');

            // Load additional images
            loadProductGallery(sku);
        }

        async function loadProductGallery(sku) {
            try {
                const response = await fetch(`${API_BASE}/api/products/${sku}/images`);
                if (response.ok) {
                    const images = await response.json();
                    const gallery = document.getElementById('productGallery');
                    if (images.length > 1) {
                        gallery.innerHTML = images.slice(1).map(img => `
                            <img src="${API_BASE}${img}" alt="Product image" style="width: 100%; border-radius: 4px; cursor: pointer;" onclick="this.parentElement.previousElementSibling.src=this.src">
                        `).join('');
                    }
                }
            } catch (e) {
                console.log('Could not load gallery images');
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        async function loadAnalytics() {
            try {
                const pageViewsRes = await fetch(`${API_BASE}/api/tracking/page-views`);
                if (pageViewsRes.ok) {
                    const pageViews = await pageViewsRes.json();
                    document.getElementById('totalPageViews').textContent = pageViews.length;
                    
                    const uniqueVisitors = new Set(pageViews.map(pv => pv.session_id)).size;
                    document.getElementById('uniqueVisitors').textContent = uniqueVisitors;
                    
                    const conversionRate = orders.length > 0 && uniqueVisitors > 0 
                        ? ((orders.length / uniqueVisitors) * 100).toFixed(1) 
                        : 0;
                    document.getElementById('conversionRate').textContent = conversionRate + '%';
                    
                    const avgTime = pageViews.reduce((sum, pv) => sum + (pv.time_on_page || 0), 0) / pageViews.length || 0;
                    document.getElementById('avgSessionTime').textContent = Math.round(avgTime) + 's';
                    
                    // Display traffic sources
                    displayTrafficSources(pageViews);
                }
                
                // Display buyer locations
                displayBuyerLocations();
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function displayBuyerLocations() {
            // Aggregate locations from completed orders
            const completedOrders = orders.filter(o => o.status === 'completed');
            const stateCounts = {};
            const cityCounts = {};
            
            completedOrders.forEach(order => {
                try {
                    const billing = typeof order.billing === 'string' ? JSON.parse(order.billing) : order.billing;
                    
                    if (billing) {
                        const state = billing.state || billing.billing_state;
                        const city = billing.city || billing.billing_city;
                        
                        if (state) {
                            stateCounts[state] = (stateCounts[state] || 0) + 1;
                        }
                        
                        if (city && state) {
                            const cityKey = `${city}, ${state}`;
                            cityCounts[cityKey] = (cityCounts[cityKey] || 0) + 1;
                        }
                    }
                } catch (e) {
                    // Skip orders with invalid billing data
                }
            });
            
            // Sort and get top 10
            const topStates = Object.entries(stateCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const topCities = Object.entries(cityCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Display top states
            const statesContainer = document.getElementById('topStates');
            if (topStates.length === 0) {
                statesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No location data available</div>';
            } else {
                const totalOrders = completedOrders.length;
                statesContainer.innerHTML = topStates.map(([state, count]) => {
                    const percentage = ((count / totalOrders) * 100).toFixed(1);
                    return `
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3498db;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1rem; color: #2c3e50;">${state}</div>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 2px;">${percentage}% of orders</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: #3498db;">${count}</div>
                                <div style="font-size: 0.8rem; color: #999;">orders</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Display top cities
            const citiesContainer = document.getElementById('topCities');
            if (topCities.length === 0) {
                citiesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No location data available</div>';
            } else {
                const totalOrders = completedOrders.length;
                citiesContainer.innerHTML = topCities.map(([city, count]) => {
                    const percentage = ((count / totalOrders) * 100).toFixed(1);
                    return `
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #27ae60;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1rem; color: #2c3e50;">${city}</div>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 2px;">${percentage}% of orders</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: #27ae60;">${count}</div>
                                <div style="font-size: 0.8rem; color: #999;">orders</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function displayTrafficSources(pageViews) {
            const sourceCounts = {};
            
            pageViews.forEach(pv => {
                const data = typeof pv.data === 'string' ? JSON.parse(pv.data) : pv.data;
                const source = data.source || 'unknown';
                const type = data.type || 'unknown';
                
                const key = `${source}|${type}`;
                if (!sourceCounts[key]) {
                    sourceCounts[key] = { source, type, count: 0 };
                }
                sourceCounts[key].count++;
            });
            
            const sortedSources = Object.values(sourceCounts).sort((a, b) => b.count - a.count);
            const total = pageViews.length;
            
            const container = document.getElementById('trafficSources');
            
            if (sortedSources.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No traffic data yet</div>';
                return;
            }
            
            container.innerHTML = sortedSources.map(item => {
                const percentage = ((item.count / total) * 100).toFixed(1);
                
                let icon = 'üåê';
                let color = '#3498db';
                
                if (item.type === 'social') {
                    icon = 'üì±';
                    color = '#e91e63';
                } else if (item.type === 'search') {
                    icon = 'üîç';
                    color = '#4caf50';
                } else if (item.type === 'direct') {
                    icon = 'üéØ';
                    color = '#ff9800';
                } else if (item.type === 'utm') {
                    icon = 'üìä';
                    color = '#9c27b0';
                }
                
                return `
                    <div style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid ${color};">
                        <div style="font-size: 2rem; margin-right: 15px;">${icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 1.1rem; color: #2c3e50; text-transform: capitalize;">${item.source}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">${item.type} traffic</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${color};">${item.count}</div>
                            <div style="font-size: 0.85rem; color: #999;">${percentage}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Task Management Functions
        function setMilestone(milestone) {
            currentMilestone = milestone;
            
            // Update button styles
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`milestone-${i}`).style.background = i === milestone ? '#27ae60' : '#3498db';
            }
            
            displayTasks();
        }

        function togglePromptBuilder() {
            const builder = document.getElementById('promptBuilder');
            builder.style.display = builder.style.display === 'none' ? 'block' : 'none';
        }

        function suggestPrompt(type) {
            const prompts = {
                analyze: 'Analyze top 10 customers by revenue and identify patterns in their purchase behavior. Suggest 3 actionable strategies to increase repeat purchases.',
                optimize: 'Review current conversion funnel from landing page to checkout. Identify drop-off points and recommend 5 specific improvements to increase conversion rate by 20%.',
                content: 'Generate compelling product descriptions for top 5 selling products. Include benefits, features, and SEO keywords. Ensure FDA/FTC compliance.',
                campaign: 'Create a 30-day ad campaign strategy for Facebook and Instagram. Include audience targeting, budget allocation, ad copy variations, and success metrics.',
                retention: 'Build a customer retention plan targeting customers who haven\'t purchased in 60+ days. Include email sequence, special offers, and win-back incentives.'
            };
            
            document.getElementById('taskInput').value = prompts[type] || '';
            togglePromptBuilder();
        }

        function addTask() {
            const input = document.getElementById('taskInput');
            const taskText = input.value.trim();
            
            if (!taskText) return;
            
            const task = {
                id: Date.now(),
                text: taskText,
                completed: false,
                milestone: currentMilestone,
                created: new Date().toISOString()
            };
            
            tasks[currentMilestone].push(task);
            input.value = '';
            displayTasks();
            saveTasks();
        }

        function toggleTask(taskId) {
            const task = tasks[currentMilestone].find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                displayTasks();
                saveTasks();
            }
        }

        function deleteTask(taskId) {
            tasks[currentMilestone] = tasks[currentMilestone].filter(t => t.id !== taskId);
            displayTasks();
            saveTasks();
        }

        function displayTasks() {
            const container = document.getElementById('taskList');
            const milestoneTasks = tasks[currentMilestone];
            
            if (milestoneTasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No tasks yet. Add your first task above!</div>';
                return;
            }
            
            container.innerHTML = milestoneTasks.map(task => `
                <div style="display: flex; align-items: start; gap: 10px; padding: 15px; background: ${task.completed ? '#f0f9ff' : 'white'}; border: 1px solid ${task.completed ? '#3498db' : '#ddd'}; border-radius: 8px;">
                    <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-size: 0.95rem; color: #2c3e50; ${task.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${task.text}</div>
                        <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">üìç Milestone ${task.milestone} ‚Ä¢ ${new Date(task.created).toLocaleDateString()}</div>
                    </div>
                    <button onclick="deleteTask(${task.id})" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function saveTasks() {
            localStorage.setItem('sc_tasks', JSON.stringify(tasks));
        }

        function loadTasks() {
            const saved = localStorage.getItem('sc_tasks');
            if (saved) {
                tasks = JSON.parse(saved);
                displayTasks();
            }
        }

        // SEO Optimization Functions
        let seoProducts = [];

        function loadTop12ForSEO() {
            // Get top 12 sellers by sales volume
            const productsWithSales = products.map(product => {
                let totalSales = 0;
                const completedOrders = orders.filter(o => o.status === 'completed');
                
                completedOrders.forEach(order => {
                    try {
                        const lineItems = typeof order.line_items === 'string' ? JSON.parse(order.line_items) : order.line_items;
                        if (Array.isArray(lineItems)) {
                            lineItems.forEach(item => {
                                if (item.sku === product.sku) {
                                    totalSales += parseInt(item.quantity || 0);
                                }
                            });
                        }
                    } catch (e) {}
                });
                return { ...product, salesVolume: totalSales };
            });

            seoProducts = productsWithSales.sort((a, b) => b.salesVolume - a.salesVolume).slice(0, 12);
            displaySEOProducts();
        }

        function displaySEOProducts() {
            const container = document.getElementById('seoProductList');
            
            container.innerHTML = seoProducts.map((product, index) => {
                const cleanTitle = (product.name || '').replace(/[^\w\s-]/g, '').trim();
                const cleanDesc = (product.description || '').replace(/<[^>]*>/g, '').replace(/[^\w\s.,!?-]/g, '').trim();
                
                return `
                    <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 20px; border-left: 4px solid #27ae60;">
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div style="font-size: 2rem; font-weight: 700; color: #27ae60;">#{index + 1}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1.1rem; color: #2c3e50; margin-bottom: 5px;">${product.name}</div>
                                <div style="font-size: 0.85rem; color: #666;">SKU: ${product.sku} ‚Ä¢ Sales: ${product.salesVolume} units</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">üìù Optimized Title</label>
                                <input type="text" id="seo-title-${product.id}" value="${cleanTitle}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">üìÑ SEO Description (155 chars max)</label>
                                <textarea id="seo-desc-${product.id}" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">${cleanDesc.substring(0, 155)}</textarea>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">üîë Keywords (comma-separated)</label>
                                <input type="text" id="seo-keywords-${product.id}" placeholder="supplement, health, wellness, nootropic" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">üñºÔ∏è Image Alt Text</label>
                                <input type="text" id="seo-alt-${product.id}" placeholder="High-quality [product name] supplement bottle" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem;">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateSEOPrompts() {
            if (seoProducts.length === 0) {
                alert('Please load top 12 products first!');
                return;
            }
            
            const prompts = seoProducts.map((product, index) => {
                return `Product ${index + 1}: ${product.name}
- Write an SEO-optimized product title (60 chars max)
- Write a compelling meta description (155 chars max)
- Suggest 10 relevant keywords for SEO
- Write image alt text for accessibility and SEO
- Ensure FDA/FTC compliance (no health claims)
- Focus on benefits, quality, and customer satisfaction`;
            }).join('\n\n');
            
            // Copy to clipboard
            navigator.clipboard.writeText(prompts).then(() => {
                alert('‚úÖ SEO prompts copied to clipboard! Paste into your AI assistant to generate optimized content.');
            });
        }

        async function saveAllSEO() {
            if (seoProducts.length === 0) {
                alert('No products loaded!');
                return;
            }
            
            const updates = seoProducts.map(product => {
                return {
                    id: product.id,
                    sku: product.sku,
                    name: document.getElementById(`seo-title-${product.id}`).value,
                    description: document.getElementById(`seo-desc-${product.id}`).value,
                    keywords: document.getElementById(`seo-keywords-${product.id}`).value,
                    alt_text: document.getElementById(`seo-alt-${product.id}`).value
                };
            });
            
            try {
                const response = await fetch(`${API_BASE}/api/products/bulk-update-seo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ products: updates })
                });
                
                if (response.ok) {
                    alert('‚úÖ SEO data saved successfully!');
                    loadData(); // Reload products
                } else {
                    alert('‚ùå Error saving SEO data. Check console for details.');
                }
            } catch (error) {
                console.error('Error saving SEO:', error);
                alert('‚ùå Error saving SEO data: ' + error.message);
            }
        }

        function refreshData() {
            loadData();
        }

        // Load data on page load
        loadData();
        loadTasks();
    </script>


<!-- Footer -->
    <footer class="footer">
        <div style="background: #2854a6; padding: 20px; text-align: center;">
            <a href="/cart" style="display: inline-block; margin-bottom: 10px; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"><img src="/public/images/view-cart-button.png" alt="View Cart" style="max-width: 150px; height: auto; cursor: pointer;"></a>
            <div style="display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 10px;"><img src="/public/images/Footer-Badges-.png" alt="Certification Badges" style="max-width: 350px; height: auto;"></div>
        </div>
        <div style="width: 100%; height: 3px; background: linear-gradient(90deg, #4fd0ff 0%, #ffd34d 50%, #4fd0ff 100%);"></div>
        <div style="background: #2854a6; padding: 15px 20px; display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; font-size: 0.85rem;">
            <a href="/terms-of-service.html" style="color: white; text-decoration: none; font-weight: 500; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">Terms of Service</a>
            <span style="color: rgba(255,255,255,0.3);">|</span>
            <a href="/shipping-returns.html" style="color: white; text-decoration: none; font-weight: 500; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">Shipping & Returns</a>
            <span style="color: rgba(255,255,255,0.3);">|</span>
            <a href="/payment-policy.html" style="color: white; text-decoration: none; font-weight: 500; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">Payment Policy</a>
            <span style="color: rgba(255,255,255,0.3);">|</span>
            <a href="/privacy-policy.html" style="color: white; text-decoration: none; font-weight: 500; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">Privacy Policy</a>
            <span style="color: rgba(255,255,255,0.3);">|</span>
            <a href="/contact" style="color: white; text-decoration: none; font-weight: 500; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">Contact</a>
            <span style="color: rgba(255,255,255,0.3);">|</span>
            <a href="/shop" style="color: white; text-decoration: none; font-weight: 500; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">üß™ SHOP</a>
        </div>
        <div style="width: 100%; height: 3px; background: linear-gradient(90deg, #4fd0ff 0%, #ffd34d 50%, #4fd0ff 100%);"></div>
        <div style="text-align: center; padding: 12px; background: #2854a6;"><p style="color: white; font-size: 0.85rem; margin: 0;">üóΩ Copyright 2026 - Success Chemistry¬Æ | Powered by üèÑ WindSurf</p></div>
    </footer>

</body>
</html>
