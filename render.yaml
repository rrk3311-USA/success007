services:
  # Medusa backend (API + Admin) â€“ fill DATABASE_URL, REDIS_URL, ADMIN_CORS, AUTH_CORS in Render Dashboard
  - type: web
    name: medusa-backend
    runtime: node
    plan: free
    rootDir: deploy-site/medusa-backend
    buildCommand: npm install && npm run build
    preDeployCommand: npx medusa db:migrate
    # Medusa expects start from .medusa/server (admin build lives there)
    startCommand: cd .medusa/server && npm install && npm start
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: REDIS_URL
        sync: false
      - key: COOKIE_SECRET
        generateValue: true
      - key: JWT_SECRET
        generateValue: true
      - key: MEDUSA_WORKER_MODE
        value: server
      - key: STORE_CORS
        value: https://scv2-success-chemistry.vercel.app
      - key: ADMIN_CORS
        sync: false
      - key: AUTH_CORS
        sync: false

  # Static site (deploy-site). Build only life-jet to avoid root npm install (optionalDependencies can fail on Render).
  - type: web
    name: containersuccess007
    runtime: static
    buildCommand: cd deploy-site/life-jet && npm install && npm run build
    staticPublishPath: ./deploy-site
    headers:
      - path: /images/*
        name: Cache-Control
        value: public, max-age=31536000, immutable
      - path: /*.js
        name: Cache-Control
        value: public, max-age=3600
      - path: /public/videos/*
        name: Cache-Control
        value: public, max-age=31536000, immutable
      - path: /life-jet/dist/assets/*
        name: Cache-Control
        value: public, max-age=31536000, immutable
    routes:
      - type: rewrite
        source: /product/:sku
        destination: /product/index.html?sku=:sku
      - type: rewrite
        source: /faq/:sku
        destination: /faq/index.html?sku=:sku
      - type: rewrite
        source: /life-jet
        destination: /life-jet/dist/index.html